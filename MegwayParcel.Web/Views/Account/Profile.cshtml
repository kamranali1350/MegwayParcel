@model MegwayParcel.Common.Data.Customer
@using Microsoft.AspNetCore.Http
@using MegwayParcel.Common
@{
    Layout = "/Views/Shared/_NewLayout.cshtml";
    Model.ActiveMenu = "profile";
    int percentage = 50;

    if (!string.IsNullOrEmpty(Model.DefEmailAddress) && !string.IsNullOrEmpty(Model.DefForename))
    {
        percentage = 90;
    }
}

<!-- =======================Content START -->
<section class="pt-3">
    <div class="container">
        <div class="row">
            <!-- Sidebar START -->
            @await Html.PartialAsync("_LeftMenu", Model)

            <!-- Sidebar END -->
            <!-- Main content START -->
            <div class="col-lg-8 col-xl-9">

                <!-- Offcanvas menu button -->
                <div class="d-grid mb-0 d-lg-none w-100">
                    <button class="btn btn-primary mb-4" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                        <i class="fas fa-sliders-h"></i> Menu
                    </button>
                </div>

                <div class="vstack gap-4">
                    <!-- Verified message -->
                    <div class="bg-light rounded p-3">
                        <!-- Progress bar -->
                        <div class="overflow-hidden">
                            <h6>Complete Your Profile</h6>
                            <div class="progress progress-sm bg-success bg-opacity-10">
                                <div class="progress-bar bg-success aos" role="progressbar" data-aos="slide-right" data-aos-delay="200" data-aos-duration="1000" data-aos-easing="ease-in-out" style="width: @(percentage)%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                    <span class="progress-percent-simple h6 fw-light ms-auto">@percentage%</span>
                                </div>
                            </div>
                            <p class="mb-0">Get the best out of booking by adding the remaining details!</p>
                        </div>
                        <!-- Content -->
                        <div class="bg-body rounded p-3 mt-3">
                            <ul class="list-inline hstack flex-wrap gap-2 justify-content-between mb-0">
                                <li class="list-inline-item h6 fw-normal mb-0"><a href="#"><i class="bi bi-check-circle-fill text-success me-2"></i>Verified Email</a></li>
                                <li class="list-inline-item h6 fw-normal mb-0"><a href="#"><i class="bi bi-check-circle-fill text-success me-2"></i>Verified Mobile Number</a></li>
                                <li class="list-inline-item h6 fw-normal mb-0"><a href="#" class="text-primary"><i class="bi bi-plus-circle-fill me-2"></i>Complete Basic Info</a></li>
                            </ul>
                        </div>
                    </div>
                    <form name="sentMessage" novalidate="novalidate" id="registerForm">
                        <!-- Personal info START -->
                        <div class="card border">
                            <!-- Card header -->
                            <div class="card-header border-bottom">
                                <h4 class="card-header-title">Personal Information</h4>
                            </div>

                            <!-- Card body START -->
                            <div class="card-body">
                                <!-- Form START -->
                                <div class="row g-3">
                                    <!-- Profile photo -->
                                    <input type="hidden" asp-for="CustomerId" />
                                    <div class="col-12">
                                        <label class="form-label">Upload your profile photo<span class="text-danger">*</span></label>
                                        <div class="d-flex align-items-center">
                                            <label class="position-relative me-4" for="uploadfile-1" title="Replace this pic">
                                                <!-- Avatar place holder -->
                                                <span class="avatar avatar-xl">
                                                    <img id="uploadfile-1-preview" class="avatar-img rounded-circle border border-white border-3 shadow" src="~/new-theme/assets/images/avatar/01.jpg" alt="">
                                                </span>
                                            </label>
                                            <!-- Upload button -->
                                            <label class="btn btn-sm btn-primary-soft mb-0" for="uploadfile-1">Change</label>
                                            <input id="uploadfile-1" class="form-control d-none" type="file">
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Business / Personal<span class="text-danger">*</span></label>
                                        <select asp-for="BusinessType" class="form-select js-choice">
                                            <option value="Business">Business</option>
                                            <option value="Personal">Personal</option>
                                        </select>
                                    </div>

                                    <!-- Name -->
                                    <div class="col-md-6">
                                        <label class="form-label">Account Name</label>
                                        <input asp-for="AcountName" type="text" class="form-control" />
                                    </div>

                                    <div class="col-md-6">
                                        <label>Title<span class="text-danger">*</span></label>
                                        <select asp-for="Title" class="form-select js-choice">
                                            <option value="Mr">Mr</option>
                                            <option value="Mrs">Mrs</option>
                                            <option value="Miss">Miss</option>
                                            <option value="Ms">Ms</option>
                                            <option value="Dr">Dr</option>
                                            <option value="Prof">Prof</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Forename<span class="text-danger">*</span></label>
                                        <input asp-for="ForeName" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Forname" />
                                    </div>

                                    <div class="col-md-6">
                                        <label>Surname<span class="text-danger">*</span></label>
                                        <input asp-for="SurName" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Surname" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Email Address<span class="text-danger">*</span></label>
                                        <input asp-for="Email" readonly type="text" class="form-control " required="required" data-validation-required-message="Please enter your Email" />
                                    </div>
                                    @*  <div class="col-md-6">
                                    <label>Telephone Number<span class="text-danger">*</span></label>
                                    <input asp-for="TelephoneNumber" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Confirm Telephone Number" />
                                    </div> *@
                                    <div class="col-md-6">
                                        <label>Mobile No<span class="text-danger">*</span></label>
                                        <input asp-for="MobileNo" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Confirm Telephone Number" />
                                    </div>

                                    <div class="col-md-4">
                                        <label>
                                            <input asp-for="IsVatRegistered" type="checkbox" class="border-0" />
                                            Are you VAT registered?
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <label>My VAT number is</label>
                                        <input asp-for="MyVatNumber" type="text" class="form-control border-0" />
                                        <p class="help-block text-danger"></p>

                                    </div>
                                    <div class="col-md-4">
                                        <label>EORI Number</label>
                                        <input asp-for="Eorinumber" type="text" class="form-control border-0" />
                                        <p class="help-block text-danger"></p>
                                    </div>
                                    <div class="col-md-4">
                                        <label>EORI Number</label>
                                        <input asp-for="Eorinumber" type="text" class="form-control border-0" />
                                        <p class="help-block text-danger"></p>
                                    </div>
                                    <div class="col-md-4">
                                        <label>IOSS Number</label>
                                        <input asp-for="IossNumber" type="text" class="form-control border-0" />
                                        <p class="help-block text-danger"></p>
                                    </div>
                                    @if (ViewBag.IsAdminUser == 1)
                                    {
                                        <div class="col-md-4">
                                            <label>
                                                <input asp-for="IsWithoutPayment" type="checkbox" class="border-0" />
                                                Is Without Payment
                                            </label>
                                        </div>
                                    }


                                    <div class="col-md-6">
                                        <label>
                                            <input type="checkbox" id="isSame" />
                                            Check if you want to use the same information below
                                        </label>
                                    </div>
                                </div>
                                <!-- Form END -->
                            </div>
                            <!-- Card body END -->
                        </div>
                        <!-- Personal info END -->
                        <br />
                        <!-- Update email START -->
                        <div class="card border">
                            <!-- Card header -->
                            <div class="card-header border-bottom">
                                <h4 class="card-header-title">Default Address</h4>
                            </div>

                            <!-- Card body START -->
                            <div class="card-body">
                                <div class="g-3 row">
                                    <div class="col-md-6">
                                        <label>Title<span class="text-danger">*</span></label>
                                        <select asp-for="DefTitle" class="form-select js-choice">
                                            <option value="Mr">Mr</option>
                                            <option value="Mrs">Mrs</option>
                                            <option value="Miss">Miss</option>
                                            <option value="Ms">Ms</option>
                                            <option value="Dr">Dr</option>
                                            <option value="Prof">Prof</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Forename<span class="text-danger">*</span></label>
                                        <input asp-for="DefForename" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Forname" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Surname<span class="text-danger">*</span></label>
                                        <input asp-for="DefSurname" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Surname" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Email Address<span class="text-danger">*</span></label>
                                        <input asp-for="DefEmailAddress" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Email" />
                                    </div>
                                    @*  <div class="col-md-6">
                                    <label>Telephone Number<span class="text-danger">*</span></label>
                                    <input asp-for="DefTelephoneNumber" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Confirm Telephone Number" />
                                    </div> *@

                                    <div class="col-md-6">
                                        <label>Mobile No<span class="text-danger">*</span></label>
                                        <input asp-for="DefMobileNumber" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Confirm Telephone Number" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>County<span class="text-danger">*</span></label>
                                        <input asp-for="DefCompanyName" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Confirm Telephone Number" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Address Line 1<span class="text-danger">*</span></label>
                                        <input asp-for="DefAddressLineOne" type="text" class="form-control" required="required" data-validation-required-message="Please enter your Address Line 1" />
                                    </div>

                                    <div class="col-md-6">

                                        <label>Address Line 2</label>
                                        <input asp-for="DefAddressLineTwo" type="text" class="form-control" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>City<span class="text-danger">*</span></label>
                                        <input asp-for="DefCity" type="text" class="form-control" required="required" data-validation-required-message="Please enter your City" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>County/State<span class="text-danger">*</span></label>
                                        <input asp-for="DefCounty" type="text" class="form-control" required="required" data-validation-required-message="Please enter your County/State" />

                                    </div>
                                    <div class="col-md-6">
                                        <label>Postcode<span class="text-danger">*</span></label>
                                        <input asp-for="DefPostcode" type="text" class="form-control" required="required" data-validation-required-message="Please enter your County/State" />
                                    </div>
                                    <!-- Button -->
                                    <div class="col-12 text-end">
                                        <button class="btn btn-primary mb-0" type="submit" id="sendMessageButton">
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Card body END -->
                        <!-- Update email END -->
                    </form>
                </div>
            </div>
            <!-- Main content END -->

        </div>
    </div>
</section>
<!-- =======================
Content END -->
<!-- Modal -->
<div class="modal fade" id="confirmPasswordModal" role="dialog">
    <div class="modal-dialog">
        <form id="confirmPasswordForm">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h4 class="modal-title text-light">Confirm Password</h4>
                    <button type="button" class="close" onclick="closeLoginModal();">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="row">

                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="confirmPassword" class="form-control" placeholder="enter password" />
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning mr-auto rounded-pill" onclick="closeLoginModal();">Close</button>
                    <button type="submit" id="confirmBtn" class="btn btn-primary rounded-pill">Login</button>
                </div>
            </div>
        </form>
    </div>
</div>





@*<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>*@
<script src="~/theme/mail/jqBootstrapValidation.min.js"></script>
<script>
    function closeLoginModal() {
        $('#confirmPasswordModal').modal('hide');
    }
    $('#isSame').change(function () {
        if ($(this).is(':checked')) {
            $('#DefTitle').val($('#Title').val());
            $('#DefForename').val($('#ForeName').val());
            $('#DefSurname').val($('#SurName').val());
            $('#DefTelephoneNumber').val($('#TelephoneNumber').val());
            $('#DefMobileNumber').val($('#MobileNo').val());
            $('#DefEmailAddress').val($('#Email').val());
        }
    });
    function getFormData($form) {
        var unindexed_array = $form.serializeArray();
        var indexed_array = {};

        $.map(unindexed_array, function (n, i) {
            indexed_array[n['name']] = n['value'];
        });
        return indexed_array;
    }
    $("#registerForm input, #registerForm textarea, #registerForm select").jqBootstrapValidation({
        preventSubmit: true,
        submitError: function ($form, event, errors) {
            toastr.error('Fill the required filed(s)', 'Error')
        },
        submitSuccess: function ($form, event) {
            debugger
            event.preventDefault();
            $('#confirmPasswordModal').modal('show')
        },
        filter: function () {
            return $(this).is(":visible");
        },
    });

    function updateProfile() {
        $form = $('#registerForm');
        let model = getFormData($form)


        $this = $("#sendMessageButton");
        $this.prop("readonly", true);

        $.ajax({
            url: "/Account/Save",
            type: "POST",
            data: model,
            cache: false,
            success: function () {
                //toastr.success(" successfuly", 'Success')

                setTimeout(function () {
                    window.location.href = "/Home/Index"
                }, 1000);

            },
            error: function () {
                $('#success').html("<div class='alert alert-danger'>");
                $('#success > .alert-danger').html("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;")
                    .append("</button>");
                $('#success > .alert-danger').append($("<strong>").text("Sorry " + name + ", it seems that our mail server is not responding. Please try again later!"));
                $('#success > .alert-danger').append('</div>');
                $('#contactForm').trigger("reset");
            },
            complete: function () {
                setTimeout(function () {
                    $this.prop("readonly", false);
                }, 1000);
            }
        });
    }
    setTimeout(function () {
        if ('@ViewBag.type' != 'edit') {
            //$('#registerForm input').attr('readonly', 'readonly');
            //$('#registerForm select').attr('readonly', 'readonly');
        }
    }, 1500);



    $("#confirmPasswordForm").submit(function (event) {
        event.preventDefault();

        let _login = {};
        _login.Password = $("#confirmPassword").val();
        _login.Id = $('#CustomerId').val()
        $.ajax({
            url: "/Account/VerifyPassword",
            type: "POST",
            datatype: "json",
            data: _login,
            async: false,
            success: function (data) {
                debugger;
                if (data.status == 200) {
                    toastr.success("password verify successfuly", 'Success')

                    updateProfile();
                } else {
                    toastr.error('Please enter correct password', 'Error')
                }
            },
            beforeSend: function () {
                $("#waitSpinnerId").show();
            },
            error: function (xhr) { },
            complete: function () {
                $("#waitSpinnerId").hide();
            },
        });
    });


</script>